# 架构图和核心概念

> **难度**：🟡 中等（需要一些编程基础）
>
> **阅读时间**：15 分钟

---

## 📐 系统整体架构

### 三层架构图

```
┌────────────────────────────────────────────────────────────────┐
│                    第一层：用户界面层 (Frontend)               │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │  React 组件  │  │ Custom Hooks│  │ WebRTC 客户端│           │
│  │  (UI 显示)  │←→│  (业务逻辑) │←→│  (音频传输)  │           │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
│         ↕                 ↕                 ↕                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │ LocalStorage│  │   状态管理  │  │ Web Audio API│           │
│  │  (会话存储) │  │   (useState)│  │  (音量计算)  │           │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
                              ↕ HTTP/WebSocket
┌────────────────────────────────────────────────────────────────┐
│                  第二层：服务器代理层 (Backend)                │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────┐         │
│  │         Next.js API Routes (服务器端)            │         │
│  │                                                   │         │
│  │  ┌──────────────┐      ┌──────────────┐         │         │
│  │  │ /api/realtime │      │ /api/session │         │         │
│  │  │  (WebRTC 代理)│      │  (会话管理)  │         │         │
│  │  └──────────────┘      └──────────────┘         │         │
│  │                                                   │         │
│  │  ┌──────────────────────────────────┐           │         │
│  │  │      环境变量 (.env.local)       │           │         │
│  │  │   OPENAI_API_KEY (不暴露给前端)  │           │         │
│  │  └──────────────────────────────────┘           │         │
│  └──────────────────────────────────────────────────┘         │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
                              ↕ HTTPS
┌────────────────────────────────────────────────────────────────┐
│                 第三层：外部服务层 (External Services)         │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────┐         │
│  │          OpenAI Realtime API                      │         │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐ │         │
│  │  │ 语音识别   │  │ AI 对话    │  │ 语音合成   │ │         │
│  │  │ (STT)      │  │ (GPT-4)    │  │ (TTS)      │ │         │
│  │  └────────────┘  └────────────┘  └────────────┘ │         │
│  └──────────────────────────────────────────────────┘         │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

---

## 🔄 数据流动全景图

### 1. 会话建立流程

```
用户点击"开始对话"
        ↓
┌───────────────────────────────────────────────────────────┐
│ 1. 前端: 创建新会话                                       │
│    - 生成 Session ID                                       │
│    - 初始化会话对象                                        │
│    - 保存到 LocalStorage                                   │
└───────────────────────────────────────────────────────────┘
        ↓
┌───────────────────────────────────────────────────────────┐
│ 2. 前端: 请求麦克风权限                                   │
│    - navigator.mediaDevices.getUserMedia()                 │
│    - 获取音频流                                            │
└───────────────────────────────────────────────────────────┘
        ↓
┌───────────────────────────────────────────────────────────┐
│ 3. 前端: 创建 WebRTC 连接                                 │
│    - 创建 RTCPeerConnection                                │
│    - 添加音频 track                                        │
│    - 生成 SDP Offer                                        │
└───────────────────────────────────────────────────────────┘
        ↓
┌───────────────────────────────────────────────────────────┐
│ 4. 前端 → 后端: 发送 SDP Offer                            │
│    POST /api/realtime                                      │
│    Body: { sdp: "..." }                                    │
└───────────────────────────────────────────────────────────┘
        ↓
┌───────────────────────────────────────────────────────────┐
│ 5. 后端 → OpenAI: 转发 SDP                                │
│    POST https://api.openai.com/v1/realtime                 │
│    Headers: Authorization: Bearer $OPENAI_API_KEY          │
│    Body: { model: "gpt-4o-realtime-preview", ... }         │
└───────────────────────────────────────────────────────────┘
        ↓
┌───────────────────────────────────────────────────────────┐
│ 6. OpenAI → 后端: 返回 SDP Answer                         │
│    Response: { sdp: "..." }                                │
└───────────────────────────────────────────────────────────┘
        ↓
┌───────────────────────────────────────────────────────────┐
│ 7. 后端 → 前端: 返回 SDP Answer                           │
│    Response: { sdp: "..." }                                │
└───────────────────────────────────────────────────────────┘
        ↓
┌───────────────────────────────────────────────────────────┐
│ 8. 前端: 建立 WebRTC 连接                                 │
│    - 设置 remote SDP                                       │
│    - 连接状态: connecting → connected                     │
└───────────────────────────────────────────────────────────┘
        ↓
    会话建立成功！
```

### 2. 实时对话流程

```
┌────────────────────────────────────────────────────────────┐
│ 用户说话阶段                                               │
└────────────────────────────────────────────────────────────┘
用户对着麦克风说话
        ↓
麦克风捕获音频 (Web Audio API)
        ↓
计算音量 (use-audio-volume.ts)
        ↓
显示波形动画 (real-audio-waveform.tsx)
        ↓
音频流通过 WebRTC → OpenAI
        ↓
OpenAI 实时转录 (STT)
        ↓
临时转录文字 → 前端显示
        ↓
用户停止说话
        ↓
最终转录文字 → 前端显示
        ↓
保存到会话历史 (LocalStorage)

┌────────────────────────────────────────────────────────────┐
│ AI 回复阶段                                                │
└────────────────────────────────────────────────────────────┘
OpenAI 理解用户输入
        ↓
GPT-4 生成回复文本
        ↓
文本 → 语音合成 (TTS)
        ↓
音频流通过 WebRTC → 前端
        ↓
浏览器播放音频
        ↓
同时显示回复文字
        ↓
保存到会话历史 (LocalStorage)
        ↓
等待用户下一句话...
```

---

## 🗂️ 核心模块职责划分

### 前端模块

```
app/
├── layout.tsx          # 全局布局
│   └── 职责：
│       - 设置 HTML 根结构
│       - 加载全局样式
│       - 提供主题上下文
│       - 加载字体
│
└── page.tsx            # 主页面
    └── 职责：
        - 组合所有子组件
        - 管理全局状态
        - 协调组件间通信
        - 处理用户交互
```

```
hooks/
├── use-webrtc.ts       # ⭐ WebRTC 核心逻辑
│   └── 职责：
│       - WebRTC 连接管理
│       - 音频流处理
│       - 实时转录接收
│       - 音量计算
│       - 事件处理
│
├── use-session-manager.ts  # ⭐ 会话管理
│   └── 职责：
│       - 创建/停止/删除会话
│       - 会话状态管理
│       - LocalStorage 持久化
│       - 消息同步
│       - 三层隔离机制
│
├── use-audio-volume.ts     # 音量计算
│   └── 职责：
│       - 音频分析
│       - 音量计算
│       - 波形数据生成
│
├── use-tools.ts            # AI 工具管理
│   └── 职责：
│       - 工具函数注册
│       - 工具调用处理
│
└── use-mobile.tsx          # 移动端检测
    └── 职责：
        - 检测设备类型
        - 响应式布局
```

```
components/
├── chat-layout.tsx     # 主布局组件
│   └── 职责：
│       - 整体页面布局
│       - 侧边栏显示控制
│       - 响应式设计
│
├── conversation-sidebar.tsx  # 历史对话侧边栏
│   └── 职责：
│       - 显示会话列表
│       - 会话切换
│       - 会话操作（删除等）
│
├── voice-control-panel.tsx   # 语音控制面板
│   └── 职责：
│       - 开始/停止按钮
│       - 语音选择
│       - 状态显示
│
└── message-controls.tsx      # 消息操作工具
    └── 职责：
        - 复制消息
        - 朗读消息
        - 翻译功能
```

### 后端模块

```
app/api/
├── realtime/route.ts   # WebRTC 代理
│   └── 职责：
│       - 接收前端 SDP
│       - 转发到 OpenAI
│       - 返回 SDP Answer
│       - 管理 API Key
│
└── session/route.ts    # 会话管理 API
    └── 职责：
        - 会话 CRUD 操作
        - 数据持久化
        - (目前主要在前端处理)
```

### 数据层

```
lib/
├── conversations.ts    # ⭐ 数据模型
│   └── 职责：
│       - Session 类型定义
│       - Conversation 类型定义
│       - LocalStorage 操作
│       - 数据校验
│
├── tools.ts            # AI 工具定义
│   └── 职责：
│       - 定义可用工具
│       - 工具函数实现
│
└── utils.ts            # 工具函数
    └── 职责：
        - className 合并
        - 通用辅助函数
```

### 配置层

```
config/
├── coach-instructions.ts  # ⭐ AI 提示词
│   └── 职责：
│       - AI 角色定义
│       - 教学策略
│       - 对话风格
│
└── site.ts                # 网站配置
    └── 职责：
        - 网站元数据
        - SEO 配置
```

---

## 🔑 核心概念解释

### 1. WebRTC (Web Real-Time Communication)

**是什么？**
- 网页实时通信技术
- 允许浏览器和浏览器之间、或浏览器和服务器之间直接传输音视频

**在本项目中的作用：**
```
用户麦克风 ←WebRTC→ OpenAI 服务器
   (音频输入)        (AI 处理)

OpenAI 服务器 ←WebRTC→ 用户扬声器
  (AI 语音)           (播放输出)
```

**关键组件：**
- `RTCPeerConnection`: WebRTC 连接对象
- `SDP` (Session Description Protocol): 会话描述协议
- `MediaStream`: 音频/视频流

**类比**：
就像打视频电话，但对方是 AI 而不是人。

---

### 2. SDP (Session Description Protocol)

**是什么？**
- 会话描述协议
- 描述多媒体会话的格式（音频/视频参数、网络信息等）

**工作流程：**
```
前端生成 SDP Offer (提议)
      ↓
发送给 OpenAI
      ↓
OpenAI 返回 SDP Answer (应答)
      ↓
前端接受 Answer
      ↓
连接建立成功
```

**类比**：
就像两个人打电话前先确认：
- Offer: "喂，我用手机打给你，支持高清音频"
- Answer: "好，我也用手机，咱们就用高清音频聊"

---

### 3. React Hooks

**是什么？**
- React 的功能组件中使用状态和副作用的机制
- 让函数组件拥有类组件的能力

**本项目使用的 Hooks：**

| Hook | 作用 | 示例 |
|------|------|------|
| `useState` | 状态管理 | `const [count, setCount] = useState(0)` |
| `useEffect` | 副作用处理 | 监听数据变化、订阅事件 |
| `useCallback` | 缓存函数 | 避免不必要的重新渲染 |
| `useRef` | 引用对象 | 访问 DOM 或保存可变值 |
| `useContext` | 上下文消费 | 主题、翻译等全局数据 |
| `use-webrtc` | 自定义 Hook | WebRTC 逻辑封装 |
| `use-session-manager` | 自定义 Hook | 会话管理逻辑封装 |

**类比**：
Hooks 就像工具箱里的工具，每个工具有专门的用途。

---

### 4. LocalStorage

**是什么？**
- 浏览器提供的本地存储 API
- 数据保存在用户浏览器中，关闭浏览器后仍然存在

**在本项目中的作用：**
```
会话数据存储结构：

localStorage
└── "realtime-english-sessions" (key)
    └── [
          {
            id: "uuid-1",
            title: "关于旅行的对话",
            messages: [...],
            createdAt: "2025-10-21T10:00:00Z",
            isArchived: false,
            ...
          },
          {
            id: "uuid-2",
            title: "商务英语练习",
            messages: [...],
            createdAt: "2025-10-20T15:30:00Z",
            isArchived: true,
            ...
          }
        ]
```

**优点：**
- ✅ 数据持久化
- ✅ 无需服务器
- ✅ 快速访问

**缺点：**
- ❌ 容量限制（通常 5-10MB）
- ❌ 只能存储字符串
- ❌ 不能跨设备同步

**类比**：
就像浏览器的"小笔记本"，记录你的对话历史。

---

### 5. Next.js API Routes

**是什么？**
- Next.js 提供的服务器端功能
- 可以在 Next.js 项目中编写后端 API

**结构：**
```
app/api/realtime/route.ts
  ↓
export async function POST(request: Request) {
  // 这段代码在服务器端运行
  // 可以访问环境变量（API Key）
  // 可以发起服务器端请求
  return new Response(...)
}
```

**为什么需要？**
1. **隐藏 API Key**：不暴露给前端
2. **解决跨域问题**：服务器端请求没有 CORS 限制
3. **代理请求**：解决网络访问问题

**类比**：
就像餐厅的"后厨"，顾客（前端）看不到，但在这里处理重要的事情。

---

### 6. TypeScript 类型系统

**是什么？**
- JavaScript 的超集，添加了类型检查
- 在编译时发现错误，而不是运行时

**示例：**
```typescript
// ❌ JavaScript: 运行时才发现错误
function add(a, b) {
  return a + b;
}
add("hello", "world"); // 没有错误提示，但可能不是你想要的

// ✅ TypeScript: 编译时就发现错误
function add(a: number, b: number): number {
  return a + b;
}
add("hello", "world"); // ❌ 编译错误：参数类型不匹配
```

**本项目的类型：**
- `Session`: 会话对象类型
- `Conversation`: 对话消息类型
- `ConnectionState`: 连接状态类型
- 等等...

**类比**：
就像给变量贴上"标签"，确保不会放错东西。

---

## 🏛️ 架构设计原则

### 1. 关注点分离 (Separation of Concerns)

**原则**：不同功能放在不同模块

**实践：**
```
- UI 组件只负责显示
- Hooks 负责业务逻辑
- API Routes 负责服务器端处理
- lib 负责数据操作
```

**好处：**
- 代码更清晰
- 容易维护
- 便于测试

---

### 2. 单一职责 (Single Responsibility)

**原则**：每个模块只做一件事

**实践：**
```
use-webrtc.ts      → 只负责 WebRTC 逻辑
use-session-manager.ts → 只负责会话管理
conversations.ts   → 只负责数据模型
```

**好处：**
- 代码复用
- 减少耦合
- 易于理解

---

### 3. 组件化 (Component-Based)

**原则**：UI 拆分成可复用的组件

**实践：**
```
page.tsx (主页面)
  ├── chat-layout.tsx (布局)
  │   ├── conversation-sidebar.tsx (侧边栏)
  │   ├── voice-control-panel.tsx (控制面板)
  │   └── message-controls.tsx (消息工具)
  └── ui/ (基础组件)
      ├── button.tsx
      ├── dialog.tsx
      └── ...
```

**好处：**
- 代码复用
- 易于测试
- 团队协作

---

## 📊 状态管理架构

```
┌─────────────────────────────────────────────────────────┐
│                    全局状态                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ Theme Context│  │ Translation │  │ Toast       │     │
│  │ (主题)       │  │ (翻译)      │  │ (通知)      │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                    页面级状态                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ WebRTC      │  │ Session     │  │ Messages    │     │
│  │ (连接状态)  │  │ (当前会话)  │  │ (对话记录)  │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                    组件级状态                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ Input Value │  │ Modal Open  │  │ Selected    │     │
│  │ (输入值)    │  │ (弹窗状态)  │  │ (选中项)    │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                    持久化存储                            │
│                  LocalStorage                            │
│  ┌─────────────────────────────────────────┐           │
│  │ realtime-english-sessions                │           │
│  │  - Session 1                             │           │
│  │  - Session 2                             │           │
│  │  - ...                                   │           │
│  └─────────────────────────────────────────┘           │
└─────────────────────────────────────────────────────────┘
```

---

## 🔐 安全架构

### API Key 保护

```
┌─────────────┐
│   前端代码  │ ❌ 不包含 API Key
└─────────────┘
      ↓ HTTP Request
┌─────────────┐
│ 服务器代理  │ ✅ API Key 存在这里 (.env.local)
└─────────────┘
      ↓ HTTPS Request (with API Key)
┌─────────────┐
│ OpenAI API  │
└─────────────┘
```

### HTTPS 加密

```
用户浏览器 ←HTTPS加密→ 服务器 ←HTTPS加密→ OpenAI
```

---

## ⏭️ 下一步

现在你已经理解了系统架构，建议：

1. [**学习路径建议**](./03-learning-path.md) - 制定学习计划
2. [**配置文件详解**](../02-configuration/01-package-json.md) - 深入配置
3. [**核心 Hooks 详解**](../05-hooks/01-use-webrtc.md) - 学习核心逻辑

---

**理解架构是掌握代码库的关键！** 🎯
